# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Cloud Build pipeline for grayst0-live-trader
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Send structured logs to the dedicated bucket (already IAM-granted).
logsBucket: gs://grayst0-build-logs-1746335095

options:
  substitutionOption: ALLOW_LOOSE     # unknown _VARS wonâ€™t break the build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  BUILD STEPS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:

###############################################################################
# 0. Run smoke tests in a clean Python 3.11 environment
###############################################################################
- id: build-and-test
  name: python:3.11-slim
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸ“¦ installing deps â€¦"
      pip install --quiet --no-cache-dir pytest requests pyyaml -r requirements.txt
      echo "ðŸ§ª running smoke tests â€¦"
      python -m pytest -q tests/smoke/

###############################################################################
# 1. Archive the workspace â†’ gs://grayst0-deploy  (latest.tgz + VERSION)
###############################################################################
- id: pack-and-upload
  name: gcr.io/cloud-builders/gsutil
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸ“¦  archiving workspace â€¦"
      TMP_TGZ="/tmp/latest.tgz"
      tar -czf "$$TMP_TGZ" --exclude=.git .
      echo "$COMMIT_SHA" > /tmp/VERSION
      gsutil cp "$$TMP_TGZ" gs://grayst0-deploy/latest.tgz
      gsutil cp /tmp/VERSION gs://grayst0-deploy/VERSION

###############################################################################
# 2. Wait for sandbox VM â†’ on SMOKE_PASS promote artefact to â€œprodâ€
###############################################################################
- id: promote-if-pass
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['pack-and-upload']
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸš¦ waiting for sandbox SMOKE_PASS â€¦"
      for i in {1..30}; do            # 5 minutes max
        if gsutil cat gs://grayst0-deploy/SMOKE_PASS 2>/dev/null \
             | grep -q "$SHORT_SHA"; then
          echo "âœ… sandbox passed â€“ promoting"
          gsutil cp gs://grayst0-deploy/latest.tgz \
                    gs://grayst0-prod/latest.tgz
          printf 'prod-OK %s\n' "$SHORT_SHA" \
            | gsutil cp - gs://grayst0-deploy/PROD_PASS
          exit 0
        fi
        sleep 10
      done
      echo "ðŸ›‘ sandbox did not approve within 5 min"
      exit 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  NO DOCKER IMAGES  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
images: []

# Optional custom substitutions (currently unused)
substitutions:
  _PY_VERSION: "3.11"
