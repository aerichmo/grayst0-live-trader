---
# grayst0-live-trader  â–¸  Cloud Build pipeline
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

logsBucket: gs://grayst0-build-logs-1746335095      # central log bucket

options:
  substitutionOption: ALLOW_LOOSE                  # ignore stray _VARS

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  secrets  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
availableSecrets:
  secretManager:
    - versionName: projects/$(PROJECT_ID)/secrets/GITHUB_PAT/versions/latest
      env: GITHUB_PAT          # will surface as $GITHUB_PAT inside steps

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  build steps  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:

# 0ï¸âƒ£  Build & test in a clean Python 3.11 image
- id: build-and-test
  name: python:3.11-slim
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ğŸ“¦ installing deps â€¦"
      pip install -r requirements.txt
      echo "ğŸ§ª running smoke tests â€¦"
      pytest tests/smoke

# 1ï¸âƒ£  Archive workspace â†’ gs://grayst0-deploy/latest.tgz + VERSION
- id: pack-and-upload
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['build-and-test']
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ğŸ“¦ archiving workspace â€¦"
      tar -czf /workspace/latest.tgz --exclude=.git .
      printf '%s\n' "$SHORT_SHA" > /workspace/VERSION
      gsutil cp /workspace/latest.tgz gs://grayst0-deploy/latest.tgz
      gsutil cp /workspace/VERSION    gs://grayst0-deploy/VERSION

# 2ï¸âƒ£  Promote to â€œprodâ€ once sandbox VM writes SMOKE_PASS
- id: promote-if-pass
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['pack-and-upload']
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ğŸš¦ waiting for sandbox SMOKE_PASS â€¦"
      for i in {1..30}; do
        if gsutil cat gs://grayst0-deploy/SMOKE_PASS 2>/dev/null \
            | grep -q "$SHORT_SHA"; then
          echo "âœ… sandbox passed â€“ promoting"
          gsutil cp gs://grayst0-deploy/latest.tgz \
                    gs://grayst0-deploy/latest.tgz-prod
          printf '%s\n' "$SHORT_SHA" | gsutil cp - \
                    gs://grayst0-deploy/VERSION-prod
          exit 0
        fi
        sleep 10
      done
      echo "ğŸ›‘ sandbox did not approve within 5 min"
      exit 1

# 3ï¸âƒ£  Auto-maintenance that commits changes back to GitHub
- id: make-and-commit-changes
  name: python:3.11-slim
  waitFor: ['promote-if-pass']
  env:
    - GITHUB_PAT=$$GITHUB_PAT            # marks secret as â€œusedâ€
    - GIT_AUTHOR_NAME=cloudbuild
    - GIT_AUTHOR_EMAIL=ci@grayst0
    - GIT_COMMITTER_NAME=cloudbuild
    - GIT_COMMITTER_EMAIL=ci@grayst0
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ğŸ› ï¸  auto-maintenance â€¦"
      export GITHUB_TOKEN="$GITHUB_PAT"  # used by gh / git push
      pip install --quiet -r scripts/requirements-auto.txt
      ./scripts/auto-maintain.sh

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  images (none)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
images: []

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  handy subs  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
substitutions:
  _PY_VERSION: "3.11"

