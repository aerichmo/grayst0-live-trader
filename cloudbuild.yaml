# ---------------------------------------------------------------------------
# Cloud Build pipeline for grayst0-live-trader
# ---------------------------------------------------------------------------
logsBucket: gs://grayst0-build-logs      # dedicated bucket

options:
  substitutionOption: ALLOW_LOOSE        # ignore unknown _VARS

# ---------------------------------------------------------------------------
# Build steps
# ---------------------------------------------------------------------------
steps:
##############################################################################
# 0. Run smoke tests in a clean Python 3.11 image
##############################################################################
- id: build-and-test
  name: python:3.11-slim
  entrypoint: bash
  args:
    - -ceu
    - -c
    - |
      echo "ðŸ“¦ installing deps â€¦"
      pip install --quiet pytest requests pyyaml -r requirements.txt
      echo "ðŸ§ª running smoke tests â€¦"
      python -m pytest -q tests/smoke

##############################################################################
# 1. Archive workspace â†’ gs://grayst0-deploy/latest.tgz + VERSION
##############################################################################
- id: pack-and-upload
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['build-and-test']
  entrypoint: bash
  args:
    - -ceu
    - -c
    - |
      echo "ðŸ“¦ archiving workspace â€¦"
      TAR=/tmp/latest.tgz
      tar -czf "$TAR" --exclude=.git .
      gsutil cp "$TAR" gs://grayst0-deploy/latest.tgz
      echo "$SHORT_SHA" > /tmp/VERSION
      gsutil cp /tmp/VERSION gs://grayst0-deploy/VERSION

##############################################################################
# 2. Wait for sandbox VM to post SMOKE_PASS â†’ promote artefact to â€œprodâ€
##############################################################################
- id: promote-if-pass
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['pack-and-upload']
  entrypoint: bash
  args:
    - -ceu
    - -c
    - |
      echo "ðŸš¦ waiting for sandbox SMOKE_PASS â€¦"
      for i in {1..30}; do
        if gsutil cat gs://grayst0-deploy/SMOKE_PASS 2>/dev/null |
           grep -q "${SHORT_SHA}"; then
          echo "âœ… sandbox passed â€“ promoting"
          gsutil cp gs://grayst0-deploy/latest.tgz gs://grayst0-deploy/latest.tgz-prod
          echo "${SHORT_SHA}" | gsutil cp - gs://grayst0-deploy/VERSION-prod
          exit 0
        fi
        sleep 10
      done
      echo "ðŸ›‘ sandbox did not approve in time"; exit 1

# ---------------------------------------------------------------------------
# No container images produced
# ---------------------------------------------------------------------------
images: []

# ---------------------------------------------------------------------------
# Manual substitutions (optional)
# ---------------------------------------------------------------------------
substitutions:
  _PY_VERSION: "3.11"
