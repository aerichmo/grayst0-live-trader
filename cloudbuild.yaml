# ---------------------------------------------------------------------------
# Cloud Build pipeline for **grayst0-live-trader**
# ---------------------------------------------------------------------------

# (A) send all build logs to the dedicated bucket you created
logsBucket: gs://grayst0-build-logs-1746335095

# (B) allow unknown â€œ_VARSâ€ in substitutions without failing the build
options:
  substitutionOption: ALLOW_LOOSE

# ---------------------------------------------------------------------------
# Build steps
# ---------------------------------------------------------------------------
steps:

##############################################################################
# 0 Â· Run smoke-tests in a clean Python 3.11 image
##############################################################################
- id: build-and-test
  name: python:3.11-slim
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸ“¦ installing deps â€¦"
      pip install --quiet --no-cache-dir pytest requests pyyaml -r requirements.txt
      echo "ðŸ§ª running smoke tests â€¦"
      python -m pytest -q tests/smoke/

##############################################################################
# 1 Â· Archive workspace â†’ gs://grayst0-deploy/latest.tgz  +  VERSION
##############################################################################
- id: pack-and-upload
  name: gcr.io/cloud-builders/gsutil
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸ“¦  archiving workspace â€¦"
      TMP_TGZ="/tmp/latest.tgz"
      tar -czf "$TMP_TGZ" --exclude=.git .
      echo "$SHORT_SHA" > /tmp/VERSION
      gsutil cp "$TMP_TGZ"        ${_DEPLOY_BUCKET}/latest.tgz
      gsutil cp /tmp/VERSION      ${_DEPLOY_BUCKET}/VERSION

##############################################################################
# 2 Â· Wait for sandbox SMOKE_PASS â†’ promote artefact to â€œprodâ€
##############################################################################
- id: promote-if-pass
  name: gcr.io/cloud-builders/gsutil
  waitFor: ['pack-and-upload']
  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸš¦ waiting for sandbox SMOKE_PASS â€¦"
      for i in {1..30}; do
        if gsutil cat ${_DEPLOY_BUCKET}/SMOKE_PASS 2>/dev/null | grep -q "$SHORT_SHA"; then
          echo "âœ… sandbox passed â€“ promoting"
          gsutil cp ${_DEPLOY_BUCKET}/latest.tgz  ${_DEPLOY_BUCKET}/latest.tgz-prod
          echo "$SHORT_SHA" | gsutil cp -        ${_DEPLOY_BUCKET}/VERSION-prod
          exit 0
        fi
        sleep 10
      done
      echo "ðŸ›‘ sandbox did not approve within 5 min"
      exit 1

##############################################################################
# 3 Â· Run repo auto-maintenance (generates / commits config, etc.)
##############################################################################
- id: make-and-commit-changes
  name: python:3.11-slim          # python image so we can install deps easily
  waitFor: ['promote-if-pass']
  entrypoint: bash
  env:
    - GIT_AUTHOR_NAME=cloudbuild
    - GIT_AUTHOR_EMAIL=ci@grayst0
    - GIT_COMMITTER_NAME=cloudbuild
    - GIT_COMMITTER_EMAIL=ci@grayst0
  args:
    - -ceu
    - |
      echo "ðŸ”§ running auto-maintenance â€¦"
      pip install --quiet -r scripts/requirements-auto.txt
      ./scripts/auto-maintain.sh

# ---------------------------------------------------------------------------
# No container images produced by this build
# ---------------------------------------------------------------------------
images: []

# ---------------------------------------------------------------------------
# Custom substitutions you can reference with ${_VAR}
# ---------------------------------------------------------------------------
substitutions:
  _DEPLOY_BUCKET: gs://grayst0-deploy
  _PY_VERSION: "3.11"
