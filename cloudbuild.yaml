# cloudbuild.yaml  âŸ¨totally self-containedâŸ©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logsBucket: gs://grayst0-build-logs        # handled earlier

substitutions:
  _DEPLOY_BUCKET: gs://grayst0-deploy      # bundle lands here

steps:
  # 1 â€“ build & smoke-test the repo
  - id: build-and-test
    name: python:3.11-slim
    entrypoint: bash
    args:
      - -ceu
      - |
        echo "ðŸ“¦ installing deps â€¦"
        pip install --quiet --no-cache-dir pytest requests pyyaml -r requirements.txt
        echo "ðŸ§ª running smoke tests â€¦"
        python -m pytest -q tests/smoke/

  # 2 â€“ pack the repo and upload (create .tgz in /tmp so tar never rereads it)
  - id: pack-and-upload
    name: gcr.io/cloud-builders/gsutil
    entrypoint: bash
    args:
      - -ceu
      - |
        echo "ðŸ“¦  archiving workspace â€¦"
        TMP_TGZ="/tmp/latest.tgz"
        tar -czf "${TMP_TGZ}" --exclude=.git .
        echo "$SHORT_SHA" > /tmp/VERSION
        gsutil cp "${TMP_TGZ}"       ${_DEPLOY_BUCKET}/latest.tgz
        gsutil cp /tmp/VERSION       ${_DEPLOY_BUCKET}/VERSION
timeout: 3600s
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
