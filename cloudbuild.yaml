steps:
  # 1 – run the tiny smoke-test image
  - name: python:3.11-slim
    id: build-and-test
    entrypoint: bash
    args:
      - -euxo
      - pipefail
      - |
        pip install --quiet --no-cache-dir -r requirements.txt
        python -m pytest -q tests/smoke/

  # 2 – tar the repo and upload to the sandbox bucket
  - name: gcr.io/cloud-builders/gsutil
    id: pack-and-upload
    entrypoint: bash
    args:
      - -euxo
      - pipefail
      - |
        tar -czf /workspace/latest.tgz --exclude=.git .
        echo "$SHORT_SHA" > /workspace/VERSION
        gsutil cp /workspace/latest.tgz gs://grayst0-deploy/latest.tgz
        gsutil cp /workspace/VERSION gs://grayst0-deploy/VERSION

timeout: "900s"
options:
  logging: CLOUD_LOGGING_ONLY
