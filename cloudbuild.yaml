# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# grayst0-live-trader â€” autonomous Cloud Build pipeline
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
availableSecrets:
  secretManager:
    - versionName: projects/999946030108/secrets/GITHUB_PAT/versions/latest
      env: GITHUB_PAT

logsBucket: gs://grayst0-build-logs
options: { substitutionOption: ALLOW_LOOSE }
timeout: 3600s

steps:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0 â€” build & smoke-test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: build-and-test
  name: python:3.11-slim
  entrypoint: bash
  args:
    - -ceu
    - |
        echo "ðŸ“¦ installing deps â€¦"
        pip install --quiet pytest requests pyyaml -r requirements.txt
        echo "ðŸ§ª running smoke tests â€¦"
        python -m pytest -q tests/smoke

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1 â€” archive workspace to GCS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: pack-and-upload
  name: gcr.io/cloud-builders/gsutil
  waitFor: [build-and-test]
  entrypoint: bash
  args:
    - -ceu
    - |
        echo "ðŸ“¦ archiving workspace â€¦"
        TAR=/tmp/latest.tgz
        tar -czf "$${TAR}" --exclude=.git .
        gsutil cp "$${TAR}" gs://grayst0-deploy/latest.tgz
        echo "${SHORT_SHA}" > /tmp/VERSION
        gsutil cp /tmp/VERSION gs://grayst0-deploy/VERSION

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2 â€” wait for sandbox OK, then promote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: promote-if-pass
  name: gcr.io/cloud-builders/gsutil
  waitFor: [pack-and-upload]
  entrypoint: bash
  args:
    - -ceu
    - |
        echo "ðŸš¦ waiting for sandbox SMOKE_PASS â€¦"
        for i in {1..30}; do
          if gsutil cat gs://grayst0-deploy/SMOKE_PASS 2>/dev/null | grep -q "${SHORT_SHA}"; then
            echo "âœ… sandbox passed â€“ promoting"
            gsutil cp gs://grayst0-deploy/latest.tgz gs://grayst0-deploy/latest.tgz-prod
            echo "${SHORT_SHA}" | gsutil cp - gs://grayst0-deploy/VERSION-prod
            exit 0
          fi
          sleep 10
        done
        echo "ðŸ›‘ sandbox did not approve in time"; exit 1

# 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: make-and-commit-changes
  waitFor: ['promote-if-pass']          # keep the proper ordering
  name: python:3.11                     # full image â†’ has apt, git, etc.
  secretEnv:                            # pulls the PAT from Secret Manager
    - GITHUB_PAT

  env:                                  # commit metadata
    - GIT_AUTHOR_NAME=cloudbuild
    - GIT_AUTHOR_EMAIL=ci@grayst0
    - GIT_COMMITTER_NAME=cloudbuild
    - GIT_COMMITTER_EMAIL=ci@grayst0

  entrypoint: bash
  args:
    - -ceu
    - |
      echo "ðŸ› ï¸  running auto-maintenance â€¦"
      cd "$BUILD_WORKSPACE_DIRECTORY"   # inside the cloned repo

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ install GitHub CLI (gh) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      apt-get update -qq
      apt-get install -y -qq curl git gnupg
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) \
            signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] \
            https://cli.github.com/packages stable main" \
        > /etc/apt/sources.list.d/github-cli.list
      apt-get update -qq
      apt-get install -y -qq gh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ configure token for gh / git â”€â”€â”€â”€
      export GITHUB_TOKEN="$GITHUB_PAT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ run formatters & linters â”€â”€â”€â”€â”€â”€â”€â”€
      echo "ðŸ”§ auto-maintenance started â€¦"
      pip install -q --upgrade black isort ruamel.yaml
      black .  --quiet
      isort .  --quiet

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ create / update PR if changes â”€â”€â”€
      if [[ -n $(git status --porcelain) ]]; then
        BRANCH="auto/format-$SHORT_SHA"
        git checkout -b "$BRANCH"
        git add -A
        git commit -m "style: automated formatting ($SHORT_SHA)"
        git push -u origin "$BRANCH"

        gh pr create \
          --title "chore: auto-format ($SHORT_SHA)" \
          --body  "Automated style fixes by Cloud Build" \
          --head  "$BRANCH" \
          --base  main \
          --label automation
      else
        echo "âœ… nothing to fix"
      fi
