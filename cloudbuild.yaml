# cloudbuild.yaml  âŸ¨totally self-containedâŸ©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logsBucket: gs://grayst0-build-logs        # handled earlier

substitutions:
  _DEPLOY_BUCKET: gs://grayst0-deploy      # bundle lands here

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/GITHUB_PAT/versions/latest
      env: GITHUB_PAT

steps:
  # 1 â€“ build & smoke-test the repo
  - id: build-and-test
    name: python:3.11-slim
    entrypoint: bash
    args:
      - -ceu
      - |
        echo "ðŸ“¦ installing deps â€¦"
        pip install --quiet --no-cache-dir pytest requests pyyaml -r requirements.txt
        echo "ðŸ§ª running smoke tests â€¦"
        python -m pytest -q tests/smoke/

  # 2 â€“ pack the repo and upload (archive lives in /tmp)
  - id: pack-and-upload
    name: gcr.io/cloud-builders/gsutil
    entrypoint: bash
    args:
      - -ceu
      - |
        echo "ðŸ“¦  archiving workspace â€¦"
        TMP_TGZ="/tmp/latest.tgz"
        tar -czf "$$TMP_TGZ" --exclude=.git .
        echo "$SHORT_SHA" > /tmp/VERSION
        gsutil cp "$$TMP_TGZ"       ${_DEPLOY_BUCKET}/latest.tgz
        gsutil cp /tmp/VERSION       ${_DEPLOY_BUCKET}/VERSION

  # 3 â€“ promote to prod once the sandbox marks SMOKE_PASS <sha>
  - id: promote-if-pass
    name: gcr.io/cloud-builders/gsutil
    entrypoint: bash
    args:
      - -ceu
      - |
        echo "ðŸš¦ waiting for sandbox SMOKE_PASS â€¦"
        for i in {1..30}; do
          if gsutil cat ${_DEPLOY_BUCKET}/SMOKE_PASS 2>/dev/null \
               | grep -q "$SHORT_SHA"; then
            echo "âœ… sandbox passed â€“ promoting"
            gsutil cp ${_DEPLOY_BUCKET}/latest.tgz \
                      ${_DEPLOY_BUCKET}/latest.tgz-prod
            echo "$SHORT_SHA" | gsutil cp - \
                      ${_DEPLOY_BUCKET}/VERSION-prod
            exit 0
          fi
          sleep 10
        done
        echo "ðŸ›‘ sandbox did not approve within 5 min"
        exit 1

  # 4 â€“ autonomous maintenance (direct-push with [bot-skip])
  - id: make-and-commit-changes
    name: python:3.11-slim 
    entrypoint: bash
    args:
      - -c
      - ./scripts/auto-maintain.sh
    name: python:3.11-slim
      - GITHUB_PAT        # injected from availableSecrets

timeout: 3600s

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
